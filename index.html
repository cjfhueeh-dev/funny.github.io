# åœ¨Colabä¸­è¿è¡Œå®Œæ•´çš„é‡‘èžåˆ†æž
import pandas as pd
import yfinance as yf
import matplotlib.pyplot as plt
import plotly.graph_objects as go
from datetime import datetime, timedelta
import numpy as np

# è®¾ç½®ä¸­æ–‡å­—ä½“
plt.rcParams['font.sans-serif'] = ['SimHei']
plt.rcParams['axes.unicode_minus'] = False

print("ðŸš€ é‡‘èžæ•°æ®åˆ†æžå¹³å° - ç›´æŽ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼")

# äº¤äº’å¼è¾“å…¥
ticker = input("è¯·è¾“å…¥è‚¡ç¥¨ä»£ç  (ä¾‹å¦‚: AAPL, TSLA, 000001.SS): ") or "AAPL"
days = int(input("è¯·è¾“å…¥åˆ†æžå¤©æ•° (é»˜è®¤365): ") or "365")

# èŽ·å–æ•°æ®
end_date = datetime.now()
start_date = end_date - timedelta(days=days)

print(f"æ­£åœ¨èŽ·å– {ticker} çš„æ•°æ®...")

try:
    # ä¸‹è½½æ•°æ®
    data = yf.download(ticker, start=start_date, end=end_date)
    
    if data.empty:
        print("æœªæ‰¾åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç ")
    else:
        print(f"âœ… æˆåŠŸèŽ·å– {len(data)} æ¡æ•°æ®")
        
        # è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
        data['MA20'] = data['Close'].rolling(window=20).mean()
        data['MA50'] = data['Close'].rolling(window=50).mean()
        
        # è®¡ç®—RSI
        delta = data['Close'].diff()
        gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
        rs = gain / loss
        data['RSI'] = 100 - (100 / (1 + rs))
        
        # æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        current_price = data['Close'][-1]
        prev_price = data['Close'][-2]
        change = current_price - prev_price
        change_percent = (change / prev_price) * 100
        
        print("\nðŸ“Š åŸºæœ¬ç»Ÿè®¡:")
        print(f"å½“å‰ä»·æ ¼: ${current_price:.2f}")
        print(f"æ¶¨è·Œ: ${change:.2f} ({change_percent:+.2f}%)")
        print(f"æœ€é«˜ä»·(å‘¨æœŸ): ${data['High'].max():.2f}")
        print(f"æœ€ä½Žä»·(å‘¨æœŸ): ${data['Low'].min():.2f}")
        
        # ç»˜åˆ¶ä»·æ ¼å›¾è¡¨
        plt.figure(figsize=(12, 8))
        
        # ä»·æ ¼å’Œç§»åŠ¨å¹³å‡çº¿
        plt.subplot(2, 1, 1)
        plt.plot(data.index, data['Close'], label='æ”¶ç›˜ä»·', linewidth=2)
        plt.plot(data.index, data['MA20'], label='20æ—¥å‡çº¿', alpha=0.7)
        plt.plot(data.index, data['MA50'], label='50æ—¥å‡çº¿', alpha=0.7)
        plt.title(f'{ticker} è‚¡ä»·åˆ†æž')
        plt.ylabel('ä»·æ ¼ (USD)')
        plt.legend()
        plt.grid(True, alpha=0.3)
        
        # RSIå›¾è¡¨
        plt.subplot(2, 1, 2)
        plt.plot(data.index, data['RSI'], label='RSI', color='purple')
        plt.axhline(y=70, color='r', linestyle='--', alpha=0.7, label='è¶…ä¹°çº¿')
        plt.axhline(y=30, color='g', linestyle='--', alpha=0.7, label='è¶…å–çº¿')
        plt.axhline(y=50, color='gray', linestyle='-', alpha=0.5)
        plt.ylabel('RSI')
        plt.xlabel('æ—¥æœŸ')
        plt.legend()
        plt.grid(True, alpha=0.3)
        plt.ylim(0, 100)
        
        plt.tight_layout()
        plt.show()
        
        # æ˜¾ç¤ºæœ€è¿‘çš„æ•°æ®
        print("\nðŸ“ˆ æœ€è¿‘5ä¸ªäº¤æ˜“æ—¥çš„ä»·æ ¼:")
        print(data[['Open', 'High', 'Low', 'Close']].tail())
        
except Exception as e:
    print(f"âŒ é”™è¯¯: {e}")
    print("ðŸ’¡ æç¤ºï¼šè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ ¼å¼ï¼Œä¾‹å¦‚ï¼š")
    print("   - AAPL (è‹¹æžœç¾Žè‚¡)")
    print("   - 000001.SS (ä¸Šè¯æŒ‡æ•°)")
    print("   - 0700.HK (è…¾è®¯æ¸¯è‚¡)")
